---
title: "Build a Basic HTTP Server"
id: "build-a-basic-http-server"
skillLevel: "advanced"
useCase:
  - "API Development"
summary: "Combine Layer, Runtime, and Effect to create a simple, robust HTTP server using Node.js's built-in http module."
tags:
  - "http"
  - "server"
  - "api"
  - "runtime"
  - "layer"
  - "end-to-end"
rule:
  description: "Use a managed Runtime created from a Layer to handle requests in a Node.js HTTP server."
related:
  - "create-reusable-runtime-from-layers"
  - "create-managed-runtime-for-scoped-resources"
  - "implement-graceful-shutdown"
author: "effect_website"
---

## Guideline

To build an HTTP server, create a main `AppLayer` that provides all your application's services. Compile this layer into a managed `Runtime` at startup. Use this runtime to execute an `Effect` for each incoming HTTP request, ensuring all logic is handled within the Effect system.

---

## Rationale

This pattern demonstrates the complete lifecycle of a long-running Effect application.
1.  **Setup Phase:** You define all your application's dependencies (database connections, clients, config) in `Layer`s and compose them into a single `AppLayer`.
2.  **Runtime Creation:** You use `Layer.toRuntime(AppLayer)` to create a highly-optimized `Runtime` object. This is done *once* when the server starts.
3.  **Request Handling:** For each incoming request, you create an `Effect` that describes the work to be done (e.g., parse request, call services, create response).
4.  **Execution:** You use the `Runtime` you created in the setup phase to execute the request-handling `Effect` using `Runtime.runPromise`.

This architecture ensures that your request handling logic is fully testable, benefits from structured concurrency, and is completely decoupled from the server's setup and infrastructure.

---

## Good Example

This example creates a simple server with a `Greeter` service. The server starts, creates a runtime containing the `Greeter`, and then uses that runtime to handle requests.

```typescript
import * as http from "http";
import { Effect, Layer, Runtime } from "effect";

// 1. Define a service and its layer
class Greeter extends Effect.Tag("Greeter")<
  Greeter,
  { readonly greet: () => Effect.Effect<string> }
>() {}

const GreeterLive = Layer.succeed(
  Greeter,
  Greeter.of({ greet: () => Effect.succeed("Hello, World!") }),
);

// 2. Define the main application layer
const AppLayer = GreeterLive;

// 3. The main program: create the runtime and start the server
const program = Effect.gen(function* () {
  // Create the runtime once
  const runtime = yield* Layer.toRuntime(AppLayer);
  const runPromise = Runtime.runPromise(runtime);

  const server = http.createServer((_req, res) => {
    // For each request, create and run an Effect
    const requestEffect = Greeter.pipe(
      Effect.flatMap((greeter) => greeter.greet()),
      Effect.map((message) => {
        res.writeHead(200, { "Content-Type": "text/plain" });
        res.end(message);
      }),
      Effect.catchAllCause((cause) =>
        Effect.sync(() => {
          console.error(cause);
          res.writeHead(500);
          res.end("Internal Server Error");
        }),
      ),
    );

    // Execute the request effect with our runtime
    runPromise(requestEffect);
  });

  yield* Effect.log("Server starting on http://localhost:3000");
  server.listen(3000);
});

// Run the main program to start the server
Effect.runPromise(program);
```

---

## Anti-Pattern

Creating a new runtime or rebuilding layers for every single incoming request. This is extremely inefficient and defeats the purpose of Effect's `Layer` system.

```typescript
import * as http from "http";
import { Effect, Layer } from "effect";
import { GreeterLive } from "./somewhere";

// ❌ WRONG: This rebuilds the GreeterLive layer on every request.
const server = http.createServer((_req, res) => {
  const requestEffect = Effect.succeed("Hello!").pipe(
    Effect.provide(GreeterLive), // Providing the layer here is inefficient
  );
  Effect.runPromise(requestEffect).then((msg) => res.end(msg));
});
```