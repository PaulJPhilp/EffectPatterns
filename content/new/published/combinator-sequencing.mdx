---
title: Sequencing with andThen, tap, and flatten
id: combinator-sequencing
skillLevel: beginner
provider: google
model: gemini-2.5-flashmediate
useCase:
  - Combinators
  - Sequencing
  - Composition
  - Side Effects
summary: Use andThen, tap, and flatten to sequence computations, run side
  effects, and flatten nested structures in Effect, Stream, Option, and Either.
tags:
  - sequencing
  - andThen
  - tap
  - flatten
  - combinator
  - effect
  - stream
  - option
  - either
rule:
  description: Use sequencing combinators to run computations in order, perform
    side effects, or flatten nested structures, while preserving error and
    context handling.
related:
  - combinator-flatmap
  - combinator-map
  - combinator-foreach-all
  - combinator-zip
  - combinator-error-handling
author: PaulJPhilp
expectedOutput: >-
  timestamp=2025-08-07T18:29:29.295Z level=INFO fiber=#0 message=Starting...

  timestamp=2025-08-07T18:29:29.296Z level=INFO fiber=#0 message="logThenCompute
  (andThen) result: 42"

  timestamp=2025-08-07T18:29:29.296Z level=INFO fiber=#0 message="Result is 42"

  timestamp=2025-08-07T18:29:29.296Z level=INFO fiber=#0 message="computeAndLog
  (tap) result: 42"

  timestamp=2025-08-07T18:29:29.296Z level=INFO fiber=#0 message="Option.flatten
  result: 1"

  timestamp=2025-08-07T18:29:29.297Z level=INFO fiber=#0 message="Effect.flatten
  result: 1"

  timestamp=2025-08-07T18:29:29.297Z level=ERROR fiber=#0 message="Error: fail!"

  timestamp=2025-08-07T18:29:29.301Z level=INFO fiber=#1 message="Saw: 1"

  timestamp=2025-08-07T18:29:29.301Z level=INFO fiber=#1 message="Saw: 2"

  timestamp=2025-08-07T18:29:29.302Z level=INFO fiber=#1 message="Saw: 3"

  timestamp=2025-08-07T18:29:29.311Z level=INFO fiber=#0 message="Stream.tap
  result: [1, 2, 3]"
---

# Sequencing with `andThen`, `tap`, and `flatten`

## Guideline

Use sequencing combinators to run computations in order, perform side effects, or flatten nested structures.  
- `andThen` runs one computation after another, ignoring the first result.
- `tap` runs a side-effecting computation with the result, without changing the value.
- `flatten` removes one level of nesting from nested structures.

These work for `Effect`, `Stream`, `Option`, and `Either`.

## Rationale

Sequencing is fundamental for expressing workflows.  
These combinators let you:
- Run computations in order (`andThen`)
- Attach logging, metrics, or other side effects (`tap`)
- Simplify nested structures (`flatten`)

All while preserving composability, error handling, and type safety.

## Good Example

```typescript
import { Effect, Stream, Option } from "effect";

const logThenCompute = Effect.log("Starting...").pipe(
  Effect.andThen(Effect.succeed(42))
);

const computeAndLog = Effect.succeed(42).pipe(
  Effect.tap((n) => Effect.log(`Result is ${n}`))
);

const nestedOption = Option.some(Option.some(1));
const flatOption = Option.flatten(nestedOption);

const nestedEffect = Effect.succeed(Effect.succeed(1));
const flatEffect = Effect.flatten(nestedEffect);

const mightFail = Effect.fail("fail!").pipe(
  Effect.tapError((err) => Effect.logError(`Error: ${err}`))
);

const stream = Stream.fromIterable([1, 2, 3]).pipe(
  Stream.tap((n) => Effect.log(`Saw: ${n}`))
);

const program = Effect.gen(function* () {
  const logThenComputeResult = yield* logThenCompute;
  yield* Effect.log(`logThenCompute (andThen) result: ${logThenComputeResult}`);
  const computeAndLogResult = yield* computeAndLog;
  yield* Effect.log(`computeAndLog (tap) result: ${computeAndLogResult}`);
  yield* Effect.log(
    `Option.flatten result: ${
      Option.isSome(flatOption) ? flatOption.value : "None"
    }`
  );
  const flatEffectResult = yield* flatEffect;
  yield* Effect.log(`Effect.flatten result: ${flatEffectResult}`);
  yield* Effect.either(mightFail); // tapError logs error
  const streamValues: number[] = [];
  yield* Stream.runForEach(stream, (n) =>
    Effect.sync(() => streamValues.push(n))
  );
  yield* Effect.log(`Stream.tap result: [${streamValues.join(", ")}]`);
});

Effect.runPromise(program);

```

**Explanation:**  
- `andThen` is for sequencing when you don’t care about the first result.
- `tap` is for running side effects (like logging) without changing the value.
- `flatten` is for removing unnecessary nesting (e.g., `Option<Option<A>>` → `Option<A>`).

## Anti-Pattern

Using `flatMap` with a function that ignores its argument, or manually unwrapping and re-wrapping nested structures, instead of using the dedicated combinators.