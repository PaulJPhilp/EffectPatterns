---
title: "Trace Operations Across Services with Spans"
id: "observability-tracing-spans"
skillLevel: "intermediate"
useCase: ["Observability", "Tracing", "Performance", "Debugging"]
summary: "Use Effect.withSpan to create custom tracing spans, providing detailed visibility into the performance and flow of your application's operations."
tags: ["tracing", "spans", "observability", "performance", "debugging", "effect"]
rule:
  description: "Use Effect.withSpan to create and annotate tracing spans for operations, enabling distributed tracing and performance analysis."
related: ["observability-structured-logging", "observability-custom-metrics"]
author: "PaulJPhilp"
---

# Trace Operations Across Services with Spans

## Guideline

Use `Effect.withSpan` to create custom tracing spans around important operations in your application.  
This enables distributed tracing, performance analysis, and deep visibility into how requests flow through your system.

## Rationale

Tracing spans help you understand the flow and timing of operations, especially in distributed systems or complex workflows.  
They allow you to pinpoint bottlenecks, visualize dependencies, and correlate logs and metrics with specific requests.

## Good Example

```typescript
import { Effect } from "effect";

// Trace a database query with a custom span
const fetchUser = Effect.withSpan("db.fetchUser", Effect.sync(() => {
  // ...fetch user from database
  return { id: 1, name: "Alice" };
}));

// Trace an HTTP request with additional attributes
const fetchData = Effect.withSpan(
  "http.fetchData",
  Effect.tryPromise({
    try: () => fetch("https://api.example.com/data").then(res => res.json()),
    catch: (err) => `Network error: ${String(err)}`
  }),
  { attributes: { url: "https://api.example.com/data" } }
);

// Use spans in a workflow
const program = Effect.gen(function* () {
  yield* Effect.withSpan("workflow.start", Effect.log("Starting workflow"));
  const user = yield* fetchUser;
  yield* Effect.withSpan("workflow.end", Effect.log(`Fetched user: ${user.name}`));
});
```

**Explanation:**  
- `Effect.withSpan` creates a tracing span around an operation.
- Spans can be named and annotated with attributes for richer context.
- Tracing enables distributed observability and performance analysis.

## Anti-Pattern

Relying only on logs or metrics for performance analysis, or lacking visibility into the flow of requests and operations across services.