name: Generate Patterns

on:
  # Run on schedule (daily at 00:00 UTC)
  schedule:
    - cron: '0 0 * * *'

  # Allow manual trigger
  workflow_dispatch:

  # Run on push to main (when patterns source changes)
  push:
    branches: [main]
    paths:
      - 'data/**'
      - '.github/workflows/generate-patterns.yml'

jobs:
  generate:
    name: Generate patterns.json
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout EffectPatterns source repo
        uses: actions/checkout@v5
        with:
          repository: PaulJPhilp/EffectPatterns
          path: source-patterns

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate patterns.json
        run: |
          # Create data directory if it doesn't exist
          mkdir -p data

          # Run pattern generation script (assumes toolkit has this capability)
          # This is a placeholder - adjust based on actual generation script
          bun --filter @effect-patterns/toolkit run generate:patterns \
            --source ./source-patterns \
            --output ./data/patterns.json

      - name: Verify patterns.json
        run: |
          if [ ! -f "data/patterns.json" ]; then
            echo "Error: patterns.json not generated"
            exit 1
          fi

          # Validate JSON format
          if ! cat data/patterns.json | bun run -e "JSON.parse(require('fs').readFileSync(0, 'utf-8'))"; then
            echo "Error: Invalid JSON in patterns.json"
            exit 1
          fi

          echo "âœ… patterns.json generated successfully"

      - name: Upload patterns.json as artifact
        uses: actions/upload-artifact@v4
        with:
          name: patterns-data
          path: data/patterns.json
          retention-days: 30

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet data/patterns.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated patterns
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/patterns.json
          git commit -m "chore: regenerate patterns.json from EffectPatterns source

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"
          git push
